version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: ia-challenge-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=ia_challenge
      - MYSQL_USER=app
      - MYSQL_PASSWORD=app
    volumes:
      - mysql-data:/var/lib/mysql
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ia-challenge-backend
    ports:
      - "8000:80"      # HTTP
      - "8443:443"     # HTTPS
      - "8443:443/udp" # HTTP/3
    volumes:
      - ./backend:/app
      - backend-var:/app/var
      - caddy-data:/data
      - caddy-config:/config
    environment:
      - APP_ENV=dev
      - APP_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
      - DATABASE_URL=mysql://app:app@mysql:3306/ia_challenge?serverVersion=8.0&charset=utf8mb4
      - CORS_ALLOW_ORIGIN=^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$$
      - SERVER_NAME=:80, :443
      # Mercure vars are loaded from backend/.env
      # Worker mode disabled for easier development (enable in production)
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mercure:
    image: dunglas/mercure:latest
    container_name: ia-challenge-mercure
    ports:
      - "3000:80"
    environment:
      - SERVER_NAME=:80
      - MERCURE_PUBLISHER_JWT_KEY=p1KoDtEqxReAuVphusSuYJk2nZ0tOmVs/aVHpp+t8RY=
      - MERCURE_SUBSCRIBER_JWT_KEY=p1KoDtEqxReAuVphusSuYJk2nZ0tOmVs/aVHpp+t8RY=
      - "MERCURE_EXTRA_DIRECTIVES=anonymous\ncors_origins http://localhost:5173 http://localhost:8000"
    restart: unless-stopped
    command: /usr/bin/caddy run --config /etc/caddy/Caddyfile --adapter caddyfile

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ia-challenge-frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      - VITE_API_URL=http://localhost:8000/api
    command: npm run dev -- --host
    restart: unless-stopped
    depends_on:
      - backend

volumes:
  mysql-data:
  backend-var:
  caddy-data:
  caddy-config:
  frontend-node-modules:
